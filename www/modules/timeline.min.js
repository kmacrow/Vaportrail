Array.prototype.remove=function(a,b){var c=this.slice((b||a)+1||this.length);this.length=a<0?this.length+a:a;return this.push.apply(this,c)};Array.prototype.unique=function(){for(var a=[],b=0;b<this.length;b++)a.indexOf(this[b])==-1&&a.push(this[b]);return a};Array.pick=function(a,b){for(var c=[],d=0;d<a.length;d++)b in a[d]&&c.push(a[d][b]);return c};Object.keys=function(a){var b=[],c;for(c in a)b.push(c);return b};
var TL={LiveSyncInterval:null,LiveSyncDelay:12E5,EventHashTable:{},ServicesAvailable:[],ServicesInstalled:{},AddServicesQueue:[],ServiceEventCache:{},StreamPage:0,Install:function(){TL.Activate()},Activate:function(){TL.Data.GetAppData(function(a,b){a?TL.Initialize(a,b):TL.Data.InstallAppData({install:TL.Data.Now()},function(a,b){TL.Initialize(a,b)})})},Initialize:function(a,b){function c(){if(Cookie.Exists("inithook")){var c=Cookie.Get("inithook");if(c in TL.UI)return TL.UI[c](a,b),!0}return!1}if(b.files.length){for(var d=
0;d<b.files.length;d++){var e=TL.FindService(b.files[d].meta.id);e&&(e.initAPI($.noop),TL.ServicesInstalled[e.id]=e)}c();$("#tl_no_services").hide();$("#tl_search_container").show();d=new Date;TL.UI.BuildTimeline();TL.UI.BuildAppLabels();TL.UI.TimelineRefresh();TL.UI.TimelineRefreshOverview();TL.UI.StreamRefresh();TL.UI.SetStatus("Events loaded in "+(((new Date).getTime()-d.getTime())/1E3).toFixed(2)+"s");TL.LiveSyncInterval=setInterval("TL.LiveSync()",TL.LiveSyncDelay)}else $("#tl_no_services").fadeIn(),
c()},LiveSync:function(){function a(a,c){TL.Data.DeRefPtr(c,function(f){TL.Data.DeRefPtr(f.files[0].ptr,function(g){var i=JSON.parse(g),h=TL.Data.Now();console.log("Syncing "+a+": lastSync @ "+new Date(i.lastSync*1E3));TL.ServicesInstalled[a].getEventsSince(i.lastSync,function(a){console.log(a.length+" new events.");TL.UI.TimelineAppend(a);TL.UI.TimelineAppendOverview(a);TL.UI.StreamAppend(a);i.lastSync=h;TL.Data.PutServiceData(f.files[0].ptr,i,function(){TL.Data.PutServiceEvents(c,f,a,b)})})})})}
function b(){--c==0&&(console.log("Sync complete."),$("#tl_sync").fadeOut())}console.log("LiveSync @ "+new Date);var c=0;TL.Data.GetAppData(function(b,e){if(c=e.files.length){$("#tl_sync").fadeIn();for(var f=0;f<e.files.length;f++)TL.IsServiceInstalled(e.files[f].meta.id)&&a(e.files[f].meta.id,e.files[f].ptr)}else console.log("Sync complete (no services installed.)")})},Deactivate:function(){return!0},RegisterService:function(a){TL.ServicesAvailable.push(a)},IsServiceInstalled:function(a){return a in
TL.ServicesInstalled},FindService:function(a){for(var b=0;b<TL.ServicesAvailable.length;b++)if(TL.ServicesAvailable[b].id==a)return TL.ServicesAvailable[b];return null}};TL.UI={WindowLoad:function(){$("#tl_visual").css("top",screen.availHeight/4-45+"px");$("#tl_pane").css("height",screen.availHeight/2+"px");if(!("__cl1"in localStorage))localStorage.clear(),localStorage.__cl1=1;TL.UI._SetSyntheticButtonHandlers();TL.UI._PositionSearchSuggest();setTimeout("TL.UI._PositionStreamScrollbar()",500)},WindowResize:function(){TL.UI._PositionStreamScrollbar();TL.UI._PositionSearchSuggest()},_SetSyntheticButtonHandlers:function(){$(".button").mousedown(function(){var a="button-dark-click";
$(this).hasClass("button-light")&&(a="button-light-click");$(this).hasClass("button-special")&&(a="button-special-click");$(this).addClass(a)});$(".button").mouseup(function(){var a="button-dark-click";$(this).hasClass("button-light")&&(a="button-light-click");$(this).hasClass("button-special")&&(a="button-special-click");$(this).removeClass(a)})},_PositionSearchSuggest:function(){var a=$("#tl_search").offset();$("#suggest_box").css({left:a.left+"px",top:a.top+$("#tl_search").outerHeight()+"px",width:$("#tl_search").outerWidth()-
2+"px"})},_PositionStreamScrollbar:function(){var a=$("#tl_pane_inner").offset(),b=$("#tl_pane_inner").width();$("#tl_pane_scroll_up").css({left:a.left+b-16+"px",top:a.top+3+"px"});$("#tl_pane_scroll_down").css({left:a.left+b-16+"px",top:a.top+$("#tl_pane_inner").height()-16-5+"px"})},ToggleLiveSync:function(){TL.LiveSyncInterval?(clearInterval(TL.LiveSyncInterval),TL.LiveSyncInterval=null,$("#tl_sync_switch_msg").html("Turn on LiveSync"),$("#tl_sync_switch_icon").attr("src","images/sync_off.png")):
(TL.LiveSyncInterval=setInterval("TL.LiveSync()",TL.LiveSyncDelay),$("#tl_sync_switch_msg").html("Turn off LiveSync"),$("#tl_sync_switch_icon").attr("src","images/sync_on.png"))},PopulateServiceFilters:function(){},DeleteUserData:function(a){a==!0?TL.Data.PutRootPtr(null,function(){localStorage.clear();location.reload()}):TL.UI.ShowWindow("deletedata_window")},AddServices:function(){for(var a="<table cellpadding=5><tbody>",b=0;b<TL.ServicesAvailable.length;b++){var c=TL.IsServiceInstalled(TL.ServicesAvailable[b].id);
a+=Template.Fill('<tr><td width="16">&nbsp;</td><td align="center"><img src="${logo}" height="30" /></td><td><p>${solicitation}</p></td><td><div class="button button-${btnClass}" style="display:block;width:60px;text-align:center" id="addremove_button_${id}" onclick="TL.UI.AddRemoveService(\'${id}\')">${btnLabel}</div></td><td width="16"><img id="addremove_spinner_${id}" src="images/timeline-spinner.gif" style="display:none" /></td></tr><tr><td></td><td colspan="3" style="border-bottom: ${borderBottomPx}px solid #ccc"></td></tr>',
TL.ServicesAvailable[b],{btnDisabledAttr:TL.ServicesAvailable[b].disabled?'disabled="disabled" class="disabled"':"",btnLabel:c?"Remove":"Install",btnClass:c?"light":"special",borderBottomPx:b!=TL.ServicesAvailable.length-1?1:0})}a+="</tbody></table>";$("#addservices_servicelist").html(a);TL.UI.ShowWindow("addservices_window")},AddServicesClose:function(){function a(b,d,e){console.log("Importing "+b);TL.ServicesInstalled[b].getEvents(function(f){console.log("Got "+f.length+" events.");TL.UI.TimelineAppendOverview(f);
TL.Data.PutServiceEvents(d,e,f,function(d,e){console.log(b+" events stored in IFS.");TL.UI.UpdateSearchIndex(b,e.pack(),"rebuild",1);console.log("Import "+b+" complete");if(TL.AddServicesQueue.length){var f=TL.AddServicesQueue.shift();$("#importservice_logo").attr("src",TL.ServicesInstalled[f.id].logo);a(f.id,f.ptr,f.ns)}else TL.LiveSyncInterval=setInterval("TL.LiveSync()",TL.LiveSyncDelay),TL.UI.HideWindow("importservice_window"),TL.UI.PopulateServiceFilters(),TL.UI.BuildAppLabels(),TL.UI.TimelineRefresh(),
TL.UI.StreamRefresh()})})}TL.UI.HideWindow("addservices_window");Cookie.Erase("inithook");Cookie.Erase("addQ");if(TL.AddServicesQueue.length){clearInterval(TL.LiveSyncInterval);TL.AddServicesQueue.length==Object.keys(TL.ServicesInstalled).length&&TL.UI.BuildTimeline();for(var b=0;b<TL.AddServicesQueue.length;b++)TL.UI.AddTimelineBand(TL.AddServicesQueue[b].id);TL.UI.BuildAppLabels();b=TL.AddServicesQueue.shift();$("#importservice_logo").attr("src",TL.ServicesInstalled[b.id].logo);TL.UI.ShowWindow("importservice_window");
a(b.id,b.ptr,b.ns)}else TL.UI.PopulateServiceFilters(),Object.keys(TL.ServicesInstalled).length?(TL.UI.BuildAppLabels(),TL.UI.TimelineRefresh(!0),TL.UI.StreamRefresh(),TL.UI.TimelineRefreshOverview()):($("#tl_search_container,#tl_visual,#tl_sync_switch").hide(),$("#tl_pane_scroll_up,#tl_pane_scroll_down").hide(),$("#tl_app_label").hide(),$("#tl_no_services").show(),$(".icon-tag").remove())},AddRemoveService:function(a){console.log("Add-Remove Service: "+a);Cookie.Erase("inithook");Cookie.Erase("addQ");
TL.IsServiceInstalled(a)?($("#addremove_spinner_"+a).show(),TL.Data.DelService(a,function(){console.log("Service Removed: "+a);delete TL.ServicesInstalled[a];TL.UI.RemoveTimelineBand(a);TL.UI.BuildAppLabels();$("#addremove_button_"+a).html("Install");$("#addremove_button_"+a).removeClass("button-light").addClass("button-special");$("#addremove_spinner_"+a).hide();for(var b=0;b<TL.AddServicesQueue.length;b++)if(TL.AddServicesQueue[b].id==a){TL.AddServicesQueue.remove(b);break}})):($("#addremove_spinner_"+
a).show(),TL.Data.AddService(a,{install:TL.Data.Now(),lastSync:TL.Data.Now()},function(b,c,d,e){console.log("Service Added: "+b);TL.AddServicesQueue.push({id:b,ptr:d,ns:e});TL.ServicesInstalled[a]=TL.FindService(a);TL.ServicesInstalled[a].initAPI(function(){TL.ServicesInstalled[a].isLoggedIn(function(b){$("#addremove_spinner_"+a).hide();b?($("#addremove_button_"+a).html("Remove"),$("#addremove_button_"+a).removeClass("button-special").addClass("button-light")):(Cookie.Set("inithook","RestoreAddService"),
Cookie.Set("addQ",JSON.stringify(Array.pick(TL.AddServicesQueue,"id"))),$("#addremove_button_"+a).html("Login"),document.getElementById("addremove_button_"+a).onclick=eval('(function(){TL.ServicesInstalled["'+a+'"].login(TL.UI.AuthComplete)})'),$.each(Array.pick(TL.ServicesAvailable,"id"),function(b,c){c!=a&&document.getElementById("addremove_button_"+c)}))})})}))},AuthComplete:function(a){Cookie.Erase("inithook");Cookie.Erase("addQ");$("#addremove_button_"+a).html("Remove");$("#addremove_button_"+
id).removeClass("button-special").addClass("button-light");document.getElementById("addremove_button_"+a).onclick=eval('(function(){TL.UI.AddRemoveService("'+a+'")})');$.each(Array.pick(TL.ServicesAvailable,"id"),function(b,c){c!=a&&document.getElementById("addremove_button_"+c)})},RestoreAddService:function(a,b){function c(a,b){TL.Data.DeRefPtr(b,function(c){TL.AddServicesQueue.push({id:a,ptr:b,ns:c})})}TL.UI.AddServices();TL.AddServicesQueue=[];var d=JSON.parse(Cookie.Get("addQ"));$.each(d,function(a,
d){$.each(b.files,function(a,b){if(b.meta.id==d)return c(d,b.ptr),!1})})},TimelineRefresh:function(a){function b(a){for(var b=0;b<a.length;b++)a[b].hash in TL.EventHashTable?a.remove(b--):TL.EventHashTable[a[b].hash]=1;a.length&&TL.UI.GetTimelineBandByID(a[0].type).getEventSource().loadJSON({events:a},".")}var c=Timeline.getTimelineFromID(0).getBand(0);if(!c._dragging){console.log("Refreshing timeline...");var d=c.getCenterVisibleDate();console.log("Time centered at: "+d);if(a&&a==!0){for(var e in TL.ServicesInstalled)TL.UI.GetTimelineBandByID(e).getEventSource().clear();
TL.EventHashTable={}}TL.Data.GetAppData(function(a,c){for(var e=0;e<c.files.length;e++)TL.Data.DeRefPtr(c.files[e].ptr,function(a){TL.UI.GetEventsCentredAt(a,Math.floor(d.getTime()/1E3),b)})})}},TimelineRefreshOverview:function(){function a(){Timeline.getTimelineFromID(0);var a=TL.UI.GetTimelineMonthBand().getEventSource(),b=TL.UI.GetTimelineYearBand().getEventSource();a.clear();b.clear();a.loadJSON({events:d},".");b.loadJSON({events:d},".")}function b(b){for(var f=1;f<b.files.length;f++)if(b.files[f].meta.rule)d=
d.concat(TL.UI.GenRecurOvEvents(b.files[f]));else{var g={start:new Date(b.files[f].meta.start*1E3)};if(b.files[f].meta.end>0)g.end=new Date(b.files[f].meta.end*1E3),g.durationEvent=!0;if(b.files[f].meta.color)g.color=b.files[f].meta.color;d.push(g)}--c==0&&a()}var c,d=[];TL.Data.GetAppData(function(d,f){c=f.files.length;if(!c)return a();for(var g=0;g<f.files.length;g++)TL.Data.DeRefPtr(f.files[g].ptr,b)})},GenRecurOvEvents:function(a){var b=[];if(a.meta)var c=JSON.parse(a.meta.rule),d=a.meta.start,
e=a.meta.end,f=a.meta.color?a.meta.color:"#21D6FF";else c=a.rule,d=Math.floor(a.start.getTime()/1E3),e=a.end?Math.floor(a.end.getTime()/1E3):0,f=a.color?a.color:"#21D6FF";if(c.freq=="monthly")for(var g=new Date(d*1E3),e=new Date(e?e*1E3:(new Date).getTime()+31536E6),i=g.getFullYear(),g=g.getMonth(),h=c.daynum-1,d=c.time,k=new Date((new Date(i,g,h,0,0,0,0)).getTime()+d*1E3),l=k.getHours(),j=k.getMinutes(),m=k.getSeconds();k<=e;){d={start:k,end:new Date(k.getTime()+c.duration*1E3),durationEvent:!0,
color:f};if(a.meta)d.meta=$.extend({},a.meta),d.meta.start=Math.floor(k.getTime()/1E3),d.ptr=a.ptr;b.push($.extend({},d));(g+c.interval)%12<=g&&i++;g=(g+c.interval)%12;k=new Date(i,g,h,l,j,m,0)}else if(c.freq=="weekly"){g=TL.Recurrence.GetStartOfWeek(new Date(d*1E3));for(e=e?e*1E3:(new Date).getTime()+31536E6;g<e;){for(i=0;i<c.days.length;i++){d=g+c.days[i]*TL.Recurrence.msPerDay;h=new Date(d+c.time*1E3);d={start:h,end:new Date(d+c.time*1E3+c.duration*1E3),durationEvent:!0,color:f};if(a.meta)d.meta=
$.extend({},a.meta),d.meta.start=Math.floor(h.getTime()/1E3),d.ptr=a.ptr;b.push($.extend({},d))}g+=TL.Recurrence.msPerWeek*c.interval}}return b},_TimelineAppendClean:function(a,b){for(var c=[],d=0;d<a.length;d++){if(!a[d].hash)a[d].hash=TL.Data.HashEvent(a[d]);a[d].hash in TL.EventHashTable||(a[d].rule?b&&(c=c.concat(TL.UI.GenRecurOvEvents(a[d]))):c.push(a[d]))}return c},TimelineAppend:function(a){a.length&&TL.UI.GetTimelineBandByID(a[0].type).getEventSource().loadJSON({events:TL.UI._TimelineAppendClean(a,
!1)},".")},TimelineAppendOverview:function(a){var b=TL.UI.GetTimelineMonthBand().getEventSource(),c=TL.UI.GetTimelineYearBand().getEventSource(),a=TL.UI._TimelineAppendClean(a,!0);b.loadJSON({events:a},".");c.loadJSON({events:a},".")},StreamAppend:function(a){if(a.length){for(var a=a.sort(function(a,b){return b.start.getTime()-a.start.getTime()}),b='<div id="bulk_entry_'+a[0].hash+'" style="display:none">',c=0;c<a.length;c++)b+=TL.UI._StreamEntry(a[c],!0);b+="</div>";$(b).prependTo("#tl_pane_scroll");
$("#tl_pane_scroll").animate({top:"0px"},500,function(){$("#bulk_entry_"+a[0].hash).slideDown();TL.UI.StreamScrollCheck()})}},StreamScroll:function(a){var b=parseInt($("#tl_pane_scroll").css("top"));if(a)b+=200,b>0&&(b=0);else if(Math.abs(b)<$("#tl_pane_scroll").height()-$("#tl_pane_inner").height())b-=200;else{b-=200;$("#tl_pane_scroll").animate({top:b+"px"});$("#stream_title").html().indexOf("Search")==-1&&TL.UI.StreamRefresh(!0);return}$("#tl_pane_scroll").animate({top:b+"px"})},StreamScrollCheck:function(){var a=
$("#tl_pane_inner").height();$("#tl_pane_scroll").height()>a?($("#tl_pane_scroll_up").show(),$("#tl_pane_scroll_down").show()):($("#tl_pane_scroll_up").hide(),$("#tl_pane_scroll_down").hide())},StreamSeekTime:function(a){a=new Date(a);Timeline.getTimelineFromID(0).getBand(0).setCenterVisibleDate(a)},StreamRefresh:function(a){function b(a){if(a){for(var b=1;b<a.files.length;b++){var d=a.files[b];if(d.meta.rule)for(var f=Math.floor((new Date).getTime()/1E3),d=TL.UI.GenRecurOvEvents(d),j=0;j<d.length;j++)d[j].meta.start>=
f||e.push(d[j]);else e.push(d)}if(--g==0)return c()}}function c(){e=e.sort(function(a,b){return b.meta.start-a.meta.start});var a=TL.StreamPage*15;f=e.length>a?e.slice(a,a+15):[];return f.length?d(f.shift()):void 0}function d(a){store.getfile(a.ptr,{success:function(b){if(b){b=JSON.parse(b);if(b.rule)b.start=a.start,b.end=a.end?a.end:0;else if(b.start=new Date(b.start),b.end)b.end=new Date(b.end);document.getElementById("tl_pane_scroll").innerHTML+=TL.UI._StreamEntry(b);f.length?d(f.shift()):TL.UI.StreamScrollCheck()}}})}
var e=[],f=[],g=0;a?TL.StreamPage++:(document.getElementById("tl_pane_scroll").innerHTML="",$("#tl_pane_scroll").css("top","0px"),TL.StreamPage=0);TL.Data.GetAppData(function(a,c){if(g=c.files.length)for(var d=0;d<c.files.length;d++)TL.Data.DeRefPtr(c.files[d].ptr,b)})},_StreamEntry:function(a,b){function c(a){var b=a.getMinutes(),a=a.getHours();return(a==0?"00":a)+":"+(b==0?"00":b)}function d(a){var b=new Date;return a.getDate()==b.getDate()&&a.getFullYear()==b.getFullYear()&&a.getMonth()==b.getMonth()?
"Today":g[a.getDay()]+", "+i[a.getMonth()]+" "+a.getDate()}function e(a){var b=new Date,c=b.getTime()-(b.getHours()*36E5+b.getMinutes()*6E4+b.getSeconds()*1E3+b.getMilliseconds());return new Date(c+a*1E3+b.getTimezoneOffset()*6E4)}var f="",g=["Sun","Mon","Tues","Wed","Thu","Fri","Sat"],i=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];if(a.rule){var h=a.rule,f="Every ";h.interval&&h.interval>1&&(f+=h.interval);h.freq=="monthly"?(h.interval&&h.interval>1?f+=" months":f="Monthly",
f+=" on the "+h.daynum):h.freq=="weekly"&&(h.interval&&h.interval>1?f+=" weeks":f="Weekly",f+=" "+$.map(h.days,function(a){return g[a]}).join(", "));f+=h.time&&h.duration?" from "+c(e(h.time))+" - "+c(e(h.time+h.duration)):" at "+c(e(h.time))}else f=a.start&&a.end?c(a.start)+" - "+c(a.end)+" "+d(a.start):"at "+c(a.start)+" "+d(a.start);f={datetime:f,entry_id:"entry_"+a.hash,icon:a.appIcon,start_ms:a.start.getTime(),title:a.title?a.title:a.caption?a.caption:"Untitled event",description:(a.stream?a.stream:
a.description).length<=50?a.stream?a.stream:a.description:(a.stream?a.stream:a.description).substring(0,50)+"..."};return Template.Fill('<div class="pane-entry'+(b&&b==!0?" pane-entry-new":"")+'" id="${entry_id}"> \t\t\t\t\t<table width="100%"> \t\t\t\t\t\t<tr><td rowspan="3" valign="top" width="26"><img src="${icon}" class="pane-entry-icon" /></td> \t\t\t\t\t\t    <td><b><span style="cursor:pointer" onclick="TL.UI.StreamSeekTime(${start_ms})">${title}</span></b></td></tr> \t\t\t\t\t\t<tr> \t\t\t\t\t\t    <td>${description}</td></tr> \t\t\t\t\t\t<tr><td><small>${datetime}</small></td></tr> \t\t\t\t\t</table> \t\t\t\t      </div>',
f)},SetStatus:function(a){$("#tl_status").html(a)},SearchKeyPress:function(){switch(event.keyCode){case 13:clearTimeout(TL.UI.LiveSearchTimeout);TL.UI.SearchTrigger();break;case 38:TL.UI.SearchSuggestScroll(1);break;case 40:TL.UI.SearchSuggestScroll(0);break;default:clearTimeout(TL.UI.LiveSearchTimeout),TL.UI.LiveSearchTimeout=setTimeout("TL.UI.SearchTrigger()",100)}},SearchSuggestScroll:function(a){var b=$("#suggest_box").data("selectedIndex"),c=$("#suggest_box").children().length;$("#suggest_box").children().removeClass("selected");
a?b>0&&(b=(b-1)%c):b=(b+1)%c;b>=0&&($($("#suggest_box").children()[b]).addClass("selected"),$("#tl_search").val($($("#suggest_box").children()[b]).html()));$("#suggest_box").data("selectedIndex",b)},SearchFocusBlur:function(){$("#suggest_box").fadeOut()},SearchTrigger:function(){var a=$("#tl_search").val().trim();a==""?TL.UI.SearchDisplayResult({numhits:0,results:[],suggest:[]}):(a.indexOf(" ")!=-1?a='"'+a+'"':a+="*",TL.UI.QueryMergedIndices(Object.keys(TL.ServicesInstalled),a,function(a){TL.UI.SearchDisplayResult(a)}))},
SearchDisplayResult:function(a){function b(a){a=JSON.parse(a);a.start=new Date(Date.parse(a.start));if(a.end)a.end=new Date(Date.parse(a.end));a.rule||TL.UI.SearchAddOverviewMark(a.start);$("#tl_pane_scroll").append(TL.UI._StreamEntry(a));TL.UI.StreamScrollCheck()}$("#stream_link").show();$("#suggest_box").html("");$("#tl_pane_scroll").html("");TL.UI.SearchRemoveOverviewMarks();TL.StreamPage=0;$("#suggest_box").data("selectedIndex",-1);for(var c=0;c<a.suggest.length;c++)$("#suggest_box").append("<div onclick=\"$('#tl_search').val($(this).html());TL.UI.SearchTrigger()\">"+
a.suggest[c]+"</div>");a.suggest.length?$("#suggest_box").show():$("#suggest_box").hide();if(a.results.length)for(c=0;c<a.results.length;c++)store.getfile(new ifs.objects.Capability(a.results[c]._cap_),{success:b});else $("#tl_pane_scroll").html('<div class="pane-message">No results found.</div>'),TL.UI.StreamScrollCheck()},SearchRevertToStream:function(){$("#stream_link").hide();TL.UI.SearchRemoveOverviewMarks();TL.UI.StreamRefresh()},UpdateSearchIndex:function(a,b,c,d){TL.UI.SetStatus("Indexing your data for search...");
$.ajax({url:store.app_url+"/treadstone/index",type:"POST",data:{root:b,mode:c,offset:d,index:a},dataType:"json",success:function(a){TL.UI.SetStatus("");console.log("Indexing Complete: ",a)},error:function(){TL.UI.SetStatus("");console.log("Indexing failed.")}})},SearchAddOverviewMark:function(a){function b(a){var b=document.createElement("div");b.className="timeline-x-marker";b.style.left=a+"px";return b}var c=TL.UI.GetTimelineYearBand(),d=TL.UI.GetTimelineMonthBand();c._etherPainter._backgroundLayer.appendChild(b(c.dateToPixelOffset(a)));
d._etherPainter._backgroundLayer.appendChild(b(d.dateToPixelOffset(a)))},SearchRemoveOverviewMarks:function(){$(".timeline-x-marker").remove()},QueryMergedIndices:function(a,b,c){function d(b){e.latency+=b.latency;e.numhits+=b.numhits;e.results=e.results.concat(b.results);e.suggest=e.suggest.concat(b.suggest.slice(0,Math.floor(10/a.length)));if(--f==0)e.suggest=e.suggest.unique(),c(e)}var e={latency:0,numhits:0,results:[],suggest:[],status:!0},f=a.length;if(!f)return c(e);for(var g=0;g<a.length;g++)$.ajax({url:store.app_url+
"/treadstone/search",type:"GET",data:{q:b,index:a[g]},dataType:"json",success:d,error:function(){console.log("Search failed.")}})},GetEventsCentredAt:function(a,b,c){function d(a){a&&g.push(JSON.parse(a));if(--i==0){console.log(g.length+" events clustered around "+b);for(var a=[],d=0;d<g.length;d++){var e=g[d];if(e.rule){var f=h.getTime()-h.getHours()*36E5-h.getMinutes()*6E4-h.getSeconds()*1E3;e.start=new Date(f+e.rule.time*1E3);e.end=new Date(f+e.rule.time*1E3+e.rule.duration*1E3);e.hash=MD5(""+
e.start+e.title);a.push(g[d])}else a.push(e)}c(a)}}function e(){d(null)}for(var f=[],g=[],i,h=new Date(b*1E3),k=TL.Recurrence.GetStartOfWeek(h),l=1;l<a.files.length;l++){var j=a.files[l];if(j.meta.rule){if(!(j.meta.start>=b+43200)&&!(j.meta.start<=b-43200&&j.meta.end<=b-43200&&j.meta.end!=0)){var m=JSON.parse(j.meta.rule);if(m.freq=="monthly")h.getDate()==m.daynum&&f.push(j.ptr);else if(m.freq=="weekly"&&m.days.indexOf(h.getDay())!=-1){var n=TL.Recurrence.GetStartOfWeek(new Date(j.meta.start*1E3));
Math.abs(k-n)%(TL.Recurrence.msPerWeek*m.interval)==0&&f.push(j.ptr)}}}else j.meta.start>=b-43200&&j.meta.start<=b+43200?f.push(j.ptr):j.meta.end>=b-43200&&j.meta.end<=b+43200?f.push(j.ptr):j.meta.start<=b-43200&&j.meta.end>=b+43200&&f.push(j.ptr)}i=f.length;if(!i)return c([]);for(l=0;l<f.length;l++)store.getfile(f[l],{success:d,error:e})},BuildTimeline:function(){console.log("Building Timeline...");$("#tl_no_services").hide();$("#tl_visual,#tl_search_container").show();$("#tl_sync_switch,#tl_pane_scroll_up,#tl_pane_scroll_down").show();
$("#tl_timeline").css("height",Math.floor(screen.height/2)+"px");TL.UI._PositionStreamScrollbar();var a=[];a.push(Timeline.createBandInfo({overview:!0,eventSource:new Timeline.DefaultEventSource,width:"10%",intervalPixels:500,intervalUnit:Timeline.DateTime.MONTH}));a.push(Timeline.createBandInfo({overview:!0,eventSource:new Timeline.DefaultEventSource,width:"10%",intervalPixels:700,intervalUnit:Timeline.DateTime.YEAR}));a[1].syncWith=0;a=Timeline.create(document.getElementById("tl_timeline"),a);Timeline.timelines[0]=
a;var b=$("#tl_timeline").height(),c=Math.floor(b*0.1),b=Math.floor(b*0.8);a._bands[0].setBandShiftAndWidth(b,c);a._bands[1].setBandShiftAndWidth(b+c,c);a._bands[0]._div.className="timeline-band timeline-band-1";a._bands[1]._div.className="timeline-band timeline-band-2";for(var d in TL.ServicesInstalled)TL.UI.AddTimelineBand(d);TL.UI.GetTimelineMonthBand()._highlight=!0;TL.UI.GetTimelineMonthBand()._positionHighlight();TL.UI.GetTimelineYearBand()._highlight=!0;TL.UI.GetTimelineYearBand()._positionHighlight();
$(".timeline-copyright").hide()},BuildAppLabels:function(){function a(a,b,c,d){var e=document.createElement("div"),f=document.createElement("img");e.style.position="absolute";e.style.left=a+"px";e.style.top=b+"px";e.className="icon-tag";f.src=c;f.align="absmiddle";e.appendChild(f);e.innerHTML+=d;document.body.appendChild(e);return e}$(".icon-tag").remove();var b=Timeline.getTimelineFromID(0),c=$("#tl_timeline").offset(),d=$("#tl_timeline").height();if(!(b.getBandCount()<3)){var d=Math.floor(d*0.8/
(b.getBandCount()-2)),e=c.left,c=c.top;e+=5;c+=2;for(var f in TL.ServicesInstalled){for(var g=0,i=0;i<b._bands.length;i++)if(b._bands[i]._bandInfo.params.id==f){g=i;break}a(e,c+g*d,TL.ServicesInstalled[f].icon,"")}}},GetTimelineMonthBand:function(){var a=Timeline.getTimelineFromID(0);return a._bands[a._bands.length-2]},GetTimelineYearBand:function(){var a=Timeline.getTimelineFromID(0);return a._bands[a._bands.length-1]},GetTimelineBandByID:function(a){for(var b=Timeline.getTimelineFromID(0),c=0;c<
b._bands.length;c++)if(b._bands[c]._bandInfo.params.id==a)return b._bands[c];return null},AddTimelineBand:function(a){if(!TL.UI.GetTimelineBandByID(a)){console.log("Add Band: "+a);for(var b=Timeline.getTimelineFromID(0),a=Timeline.createBandInfo({eventSource:new Timeline.DefaultEventSource,width:"10%",intervalUnit:Timeline.DateTime.DAY,intervalPixels:Math.floor(screen.availWidth/1.5),params:{paintLabels:b.getBandCount()==2,id:a}}),c=[],d=TL.Recurrence.GetStartOfWeek(new Date((new Date).getTime()-
63072E6))+TL.Recurrence.msPerDay*6-(new Date).getTimezoneOffset()*6E4,e=(new Date).getTime()+63072E6;d<e;)c.push(new Timeline.SpanHighlightDecorator({color:"#ffffff",startDate:new Date(d),startLabel:"",endDate:new Date(d+TL.Recurrence.msPerDay),endLabel:"",opacity:50,cssClass:"timeline-weekend-day"})),c.push(new Timeline.SpanHighlightDecorator({color:"#ffffff",startDate:new Date(d+TL.Recurrence.msPerDay),startLabel:"",endDate:new Date(d+TL.Recurrence.msPerDay*2),endLabel:"",opacity:50,cssClass:"timeline-weekend-day"})),
d+=TL.Recurrence.msPerDay*7;a.highlight=!1;a.decorators=c;a.syncWith=b._bands.length-1;a=new Timeline._Band(b,a,0);a.setViewLength(b.getPixelLength());b._bands.splice(0,0,a);TL.UI._DistributeTimelineBands()}},RemoveTimelineBand:function(a){console.log("Remove Band: "+a);for(var b=Timeline.getTimelineFromID(0),c=0;c<b._bands.length;c++)if(b._bands[c]._bandInfo.params.id==a){b.removeDiv(b._bands[c]._div);b._bands.remove(c);TL.UI._DistributeTimelineBands();break}return null},_DistributeTimelineBands:function(){var a=
Timeline.getTimelineFromID(0),b=$("#tl_timeline").height()*0.8,c=0,d;a.getBandCount()>2&&(b/=a.getBandCount()-2);d=a.getBandCount()>3?a._bands[1].getCenterVisibleDate():new Date;if(a.getBandCount()==3){if(!a._bands[0]._isScrollListener)a._bands[0].addOnScrollListener(function(){clearTimeout(TL.ScrollTimer);TL.ScrollTimer=setTimeout("TL.UI.TimelineRefresh()",200)}),a._bands[0]._isScrollListener=!0;TL.UI._ForcePaintBandLabels(a._bands[0])}for(var b=Math.floor(b),e=0;e<a._bands.length-2;e++)a._bands[e].setBandShiftAndWidth(c,
b),a._bands[e].setCenterVisibleDate(d),a._bands[e]._div.className="timeline-band timeline-band-"+(e%2==0?"light":"dark"),c+=b;for(e=a._bands.length-1;e>0;e--)a._bands[e].setSyncWithBand(a._bands[e-1],!1)},_ForcePaintBandLabels:function(a){if(a)a._bandInfo.params.paintLabels=!0,a.paint()},ShowWindow:function(a){function b(){var a=document.getElementById(TL.UI.ActiveWindow),b=Math.floor(window.outerWidth/2-$(a).outerWidth()/2)+"px",c=Math.floor(window.innerHeight/2-$(a).outerHeight()/2)+"px";$(a).css("left",
b);$(a).css("top",c)}function c(){$("#overlay").css({height:window.innerHeight+"px",width:window.innerWidth+"px"})}TL.UI.ActiveWindow=a;$(window).resize(c);$(window).resize(b);c();b();$("#overlay").show();$("#"+a).fadeIn();TL.UI._SetSyntheticButtonHandlers()},HideWindow:function(a){$("#overlay").hide();$("#"+a).hide();TL.UI.ActiveWindow=null}};
TL.Recurrence={msPerDay:864E5,msPerWeek:6048E5,GetTimeOfDay:function(a){return a.getHours()*36E5+a.getMinutes()*6E4+a.getSeconds()*1E3},GetStartOfWeek:function(a){a.getDay();return a.getTime()-a.getDay()*TL.Recurrence.msPerDay-TL.Recurrence.GetTimeOfDay(a)}};TL.Data={store:ifs.capservice(location.protocol+"//"+location.host+"/capsrv",Cookie.Get("ifsuserid"),location.protocol+"//"+location.host),cache:{},Now:function(){return Math.floor((new Date).getTime()/1E3)},HashEvent:function(a){return MD5(""+(new Date).getTime()+a.start+a.description)},GetRootNS:function(a){store.getns(null,{success:function(b){store.getfilelist(b,{success:a})}})},PutRootPtr:function(a,b){TL.Data.GetRootNS(function(c){store.putptr(c.files[1].ptr,a,{success:b})})},DeRefPtr:function(a,
b){store.getptr(a,{success:function(a){if(!a)return b(null);store.getv(a,{success:b})}})},GetAppData:function(a){TL.Data.GetRootNS(function(b){if(!b)return a(null);TL.Data.DeRefPtr(b.files[1].ptr,function(b){if(!b)return a(null,null);a(b.meta,b)})})},PutAppData:function(a,b,c){b.meta=a;store.putfilelist(b,{success:function(d){TL.Data.PutRootPtr(d,function(){c(a,b)})}})},InstallAppData:function(a,b){var c=new ifs.objects.Filelist;TL.Data.PutAppData(a,c,b)},GetServiceEvents:function(a,b,c){TL.Data.DeRefPtr(b,
function(b){function e(e){g.push(JSON.parse(e));--i==0&&c(a,f,g,b)}b||c(a,null,[],null);var f,g=[],i=b.files.length-1;TL.Data.DeRefPtr(b.files[0].ptr,function(h){f=JSON.parse(h);if(b.files.length==1)c(a,f,g,b);else for(h=1;h<b.files.length;h++)store.getfile(b.files[h].ptr,{success:e})})})},PutServiceData:function(a,b,c){store.putfile(JSON.stringify(b),{success:function(b){store.putptr(a,b,{success:function(){c(b)}})}})},PutServiceEvents:function(a,b,c,d){if(!c.length)return d(b,null);for(a=0;a<c.length;a++){if(!c[a].hash)c[a].hash=
TL.Data.HashEvent(c[a]);store.putfile(JSON.stringify(c[a]),{success:eval("(function(cap){event_uploaded("+a+",cap)})")})}},AddService:function(a,b,c){TL.Data.GetAppData(function(d,e){store.putfile(JSON.stringify(b),{success:function(d){store.mkptr(d,{success:function(d){var f=new ifs.objects.Filelist;f.add(d);store.putfilelist(f,{success:function(d){store.mkptr(d,{success:function(d){e.files.push({ptr:d,meta:{id:a}});store.putfilelist(e,{success:function(e){TL.Data.PutRootPtr(e,function(){c(a,b,d,
f)})}})}})}})}})}})})},DelService:function(a,b){TL.Data.GetAppData(function(c,d){for(var e=0;e<d.files.length;e++)if(d.files[e].meta.id==a){d.files.remove(e);break}store.putfilelist(d,{success:function(a){TL.Data.PutRootPtr(a,b)}})})}};var store=TL.Data.store,__ifs_getfile=store.getfile,__ifs_getfilelist=store.getfilelist;store.getfile=function(a,b){if(a.opts.ref in localStorage)return b.success(localStorage[a.opts.ref]);__ifs_getfile.call(store,a,{success:function(c){localStorage[a.opts.ref]=c;b.success(c)}})};
store.getfilelist=function(a,b){if(a.opts.ref in localStorage)return b.success(ifs.objects.Filelist.fromstr(localStorage[a.opts.ref]));__ifs_getfilelist.call(store,a,{success:function(c){localStorage[a.opts.ref]=c.pack();b.success(c)}})};
